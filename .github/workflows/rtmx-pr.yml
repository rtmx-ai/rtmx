# RTMX PR Validation
# Automatically runs on PRs that modify RTM-related files
# Posts a diff comment showing what changed in the RTM

name: RTMX PR Check

on:
  pull_request:
    paths:
      - 'docs/rtm_database.csv'
      - 'rtmx.yaml'
      - '.rtmx.yaml'
      - 'tests/**/*.py'
      - 'docs/requirements/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  diff-check:
    name: RTM Diff Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install rtmx
        run: pip install rtmx

      - name: Get base RTM
        id: base
        run: |
          # Try to get baseline from base branch
          if git show origin/${{ github.base_ref }}:docs/rtm_database.csv > base-rtm.csv 2>/dev/null; then
            echo "baseline_exists=true" >> $GITHUB_OUTPUT
          else
            echo "baseline_exists=false" >> $GITHUB_OUTPUT
            echo "No baseline RTM found in base branch"
          fi

      - name: Run diff
        id: diff
        if: steps.base.outputs.baseline_exists == 'true'
        run: |
          if [ -f docs/rtm_database.csv ]; then
            rtmx diff base-rtm.csv docs/rtm_database.csv --format markdown > rtm-diff.md 2>&1 || true
            echo "diff_generated=true" >> $GITHUB_OUTPUT
          else
            echo "No current RTM found"
            echo "diff_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Run health check
        id: health
        run: |
          rtmx health --format json > health.json 2>&1 || true
          STATUS=$(jq -r '.status' health.json 2>/dev/null || echo "unknown")
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Comment PR with diff
        if: steps.diff.outputs.diff_generated == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');

            let body = '## RTM Changes\n\n';

            // Add health status
            const status = '${{ steps.health.outputs.status }}';
            const statusEmoji = {
              'healthy': ':white_check_mark:',
              'degraded': ':warning:',
              'unhealthy': ':x:'
            };
            body += `**Health Status:** ${statusEmoji[status] || ':grey_question:'} ${status}\n\n`;

            // Add diff
            try {
              const diff = fs.readFileSync('rtm-diff.md', 'utf8');
              body += diff;
            } catch (e) {
              body += '_Could not generate diff_\n';
            }

            body += '\n\n---\n_Generated by rtmx PR check_';

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## RTM Changes')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Comment PR (new RTM)
        if: steps.base.outputs.baseline_exists != 'true' && hashFiles('docs/rtm_database.csv') != ''
        uses: actions/github-script@v8
        with:
          script: |
            const status = '${{ steps.health.outputs.status }}';
            const statusEmoji = {
              'healthy': ':white_check_mark:',
              'degraded': ':warning:',
              'unhealthy': ':x:'
            };

            const body = [
              '## RTM Changes',
              '',
              '**This PR introduces a new RTM database.**',
              '',
              `**Health Status:** ${statusEmoji[status] || ':grey_question:'} ${status}`,
              '',
              'No baseline to compare against.',
              '',
              '---',
              '_Generated by rtmx PR check_'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Fail on unhealthy
        if: steps.health.outputs.status == 'unhealthy'
        run: |
          echo "RTM health check failed"
          rtmx health
          exit 1
