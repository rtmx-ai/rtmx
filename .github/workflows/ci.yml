name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 9 * * 1"  # Weekly security scan on Monday 9am UTC

jobs:
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: pytest --cov=rtmx --cov-report=xml --cov-report=term-missing --ignore=tests/bdd --ignore=tests/property --ignore=tests/chaos --ignore=tests/compliance

      - name: Upload coverage to Coveralls
        if: matrix.python-version == '3.12'
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: ./coverage.xml

  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Ruff check
        run: ruff check src/ tests/

      - name: Ruff format check
        run: ruff format --check src/ tests/

      - name: Type check
        run: mypy src/rtmx

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pip-audit

      - name: Vulnerability scan
        run: pip-audit

  marker-compliance:
    name: Test Marker Compliance
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check marker compliance
        run: |
          echo "Checking test marker compliance using pytest..."
          # Use pytest's marker-aware collection to properly count class-level markers
          TOTAL=$(pytest tests/ --collect-only 2>&1 | grep "::test_" | wc -l)
          WITH_REQ=$(pytest tests/ --collect-only -m req 2>&1 | grep "::test_" | wc -l)
          WITH_SCOPE=$(pytest tests/ --collect-only -m "scope_unit or scope_integration or scope_system" 2>&1 | grep "::test_" | wc -l)

          echo "Total tests: $TOTAL"
          echo "With @pytest.mark.req: $WITH_REQ"
          echo "With scope markers: $WITH_SCOPE"

          if [ "$TOTAL" -eq 0 ]; then
            echo "ERROR: No tests found"
            exit 1
          fi

          REQ_PCT=$((WITH_REQ * 100 / TOTAL))
          SCOPE_PCT=$((WITH_SCOPE * 100 / TOTAL))
          echo "Req marker coverage: ${REQ_PCT}%"
          echo "Scope marker coverage: ${SCOPE_PCT}%"

          # Fail if coverage drops below 80%
          if [ "$REQ_PCT" -lt 80 ]; then
            echo "ERROR: Req marker coverage is below 80% (${REQ_PCT}%)"
            exit 1
          fi
          if [ "$SCOPE_PCT" -lt 80 ]; then
            echo "ERROR: Scope marker coverage is below 80% (${SCOPE_PCT}%)"
            exit 1
          fi
          echo "Marker compliance check passed!"

  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write

    steps:
      - uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  # Closed-loop requirement verification
  # Runs after tests pass on main, updates RTM status based on test results
  verify-requirements:
    name: Verify Requirements
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [test, lint]  # Only run after tests pass
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run requirement verification
        run: |
          # Run verify with update to sync test results to RTM status
          rtmx verify --update --verbose || true
          # Show final status
          rtmx status

      - name: Commit RTM status updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/rtm_database.csv
          if git diff --staged --quiet; then
            echo "No RTM status changes to commit"
          else
            git commit -m "ci: Auto-update RTM status from test results

            Closed-loop verification: test results automatically update
            requirement status in the RTM database.

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push origin main
          fi

  # Update terminal screenshots when CLI formatting changes
  # Only runs on main branch, creates PR with updated assets
  update-screenshots:
    name: Update Screenshots
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [test, lint]  # Only run after tests pass
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -e .
          pip install ansi2image

      - name: Create demo project
        run: |
          mkdir -p /tmp/rtmx_demo/docs
          cat > /tmp/rtmx_demo/rtmx.yaml << 'YAML'
          rtmx:
            database: docs/rtm_database.csv
            requirements_dir: docs/requirements
            schema: core
          YAML

          cat > /tmp/rtmx_demo/docs/rtm_database.csv << 'CSV'
          req_id,category,subcategory,requirement_text,target_value,test_module,test_function,validation_method,status,priority,phase,notes,effort_weeks,dependencies,blocks,assignee,sprint,started_date,completed_date,requirement_file
          REQ-AUTH-001,AUTHENTICATION,Login,System shall authenticate users via OAuth 2.0,OAuth 2.0 PKCE,tests/test_auth.py,test_oauth_login,Integration Test,COMPLETE,P0,1,Core authentication,2.0,,,alice,v1.0,2024-11-01,2024-11-15,docs/requirements/AUTH/REQ-AUTH-001.md
          REQ-AUTH-002,AUTHENTICATION,Session,System shall manage user sessions with JWT,15 min expiry,tests/test_auth.py,test_jwt_session,Unit Test,COMPLETE,HIGH,1,Session management,1.5,REQ-AUTH-001,,alice,v1.0,2024-11-10,2024-11-20,docs/requirements/AUTH/REQ-AUTH-002.md
          REQ-AUTH-003,AUTHENTICATION,MFA,System shall support TOTP-based MFA,RFC 6238,tests/test_auth.py,test_totp_mfa,Integration Test,PARTIAL,HIGH,2,Multi-factor auth,2.0,REQ-AUTH-001|REQ-AUTH-002,,bob,v1.1,2024-11-25,,docs/requirements/AUTH/REQ-AUTH-003.md
          REQ-API-001,API,REST,System shall expose RESTful endpoints,OpenAPI 3.0,tests/test_api.py,test_rest_endpoints,Integration Test,COMPLETE,P0,1,REST API,3.0,REQ-AUTH-001,,charlie,v1.0,2024-10-15,2024-11-01,docs/requirements/API/REQ-API-001.md
          REQ-API-002,API,GraphQL,System shall support GraphQL queries,GraphQL spec,tests/test_api.py,test_graphql_queries,Integration Test,MISSING,MEDIUM,2,GraphQL support,4.0,REQ-API-001,,charlie,v1.2,,,docs/requirements/API/REQ-API-002.md
          REQ-API-003,API,Webhooks,System shall deliver webhooks for events,< 5s latency,tests/test_api.py,test_webhook_delivery,System Test,MISSING,MEDIUM,3,Event webhooks,2.5,REQ-API-001,,,,,,docs/requirements/API/REQ-API-003.md
          REQ-DATA-001,DATA,Storage,System shall persist data in PostgreSQL,ACID compliant,tests/test_data.py,test_postgres_storage,Integration Test,COMPLETE,P0,1,Database layer,2.0,,,dave,v1.0,2024-10-01,2024-10-20,docs/requirements/DATA/REQ-DATA-001.md
          REQ-DATA-002,DATA,Cache,System shall cache frequently accessed data,Redis cluster,tests/test_data.py,test_redis_cache,Integration Test,PARTIAL,HIGH,1,Caching layer,1.5,REQ-DATA-001,,dave,v1.0,2024-10-15,,docs/requirements/DATA/REQ-DATA-002.md
          REQ-DATA-003,DATA,Backup,System shall perform automated backups,Daily snapshots,tests/test_data.py,test_backup_automation,System Test,MISSING,HIGH,2,Backup automation,2.0,REQ-DATA-001,REQ-DATA-004,eve,v1.1,,,docs/requirements/DATA/REQ-DATA-003.md
          REQ-DATA-004,DATA,Recovery,System shall support point-in-time recovery,< 1 hour RPO,tests/test_data.py,test_pitr_recovery,System Test,NOT_STARTED,HIGH,3,Disaster recovery,3.0,REQ-DATA-003,,eve,,,docs/requirements/DATA/REQ-DATA-004.md
          REQ-UI-001,UI,Dashboard,System shall provide real-time dashboard,< 100ms refresh,tests/test_ui.py,test_dashboard_refresh,E2E Test,COMPLETE,HIGH,1,Main dashboard,3.0,REQ-API-001,,frank,v1.0,2024-11-01,2024-11-25,docs/requirements/UI/REQ-UI-001.md
          REQ-UI-002,UI,Mobile,System shall support responsive mobile view,iOS/Android,tests/test_ui.py,test_mobile_responsive,E2E Test,PARTIAL,MEDIUM,2,Mobile support,2.5,REQ-UI-001,,frank,v1.1,2024-11-20,,docs/requirements/UI/REQ-UI-002.md
          CSV

      - name: Generate screenshots
        run: |
          cd /tmp/rtmx_demo
          mkdir -p $GITHUB_WORKSPACE/docs/assets

          # Generate status screenshot
          script -q -c "rtmx status" /dev/null | grep -v "^Script " > /tmp/status.txt
          ansi2image /tmp/status.txt -o $GITHUB_WORKSPACE/docs/assets/rtmx-status.png

          # Generate backlog screenshot
          script -q -c "rtmx backlog" /dev/null | grep -v "^Script " > /tmp/backlog.txt
          ansi2image /tmp/backlog.txt -o $GITHUB_WORKSPACE/docs/assets/rtmx-backlog.png

          # Generate health screenshot
          script -q -c "rtmx health" /dev/null | grep -v "^Script " > /tmp/health.txt
          ansi2image /tmp/health.txt -o $GITHUB_WORKSPACE/docs/assets/rtmx-health.png

      - name: Create PR with updated screenshots
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/assets/*.png
          if git diff --staged --quiet; then
            echo "No screenshot changes to commit"
          else
            BRANCH="auto/update-screenshots-$(date +%Y%m%d-%H%M%S)"
            git checkout -b "$BRANCH"
            git commit -m "docs: Auto-update terminal screenshots"
            git push origin "$BRANCH"

            # Try to create PR, but don't fail if permissions don't allow it
            if gh pr create \
              --title "docs: Auto-update terminal screenshots" \
              --body "Automated PR to update CLI terminal screenshots in docs/assets/." \
              --base main \
              --head "$BRANCH"; then
              echo "PR created successfully"
            else
              echo "::warning::Could not create PR automatically. Please create a PR from branch: $BRANCH"
              echo "Branch pushed: $BRANCH"
              echo "Create PR at: https://github.com/${{ github.repository }}/compare/main...$BRANCH"
            fi
          fi
