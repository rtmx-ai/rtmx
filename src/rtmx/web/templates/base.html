<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RTMX Dashboard{% endblock %}</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/ws.js"></script>
</head>
<body hx-ext="ws" ws-connect="/ws">
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">RTMX</a>
        </div>
        <div class="nav-links">
            <a href="/" class="{% if request.url.path == '/' or request.url.path == '/dashboard' %}active{% endif %}">Dashboard</a>
            <a href="/backlog" class="{% if request.url.path == '/backlog' %}active{% endif %}">Backlog</a>
        </div>
    </nav>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <p>RTMX - Requirements Traceability Matrix</p>
    </footer>

    <script>
        // WebSocket reconnection with exponential backoff
        (function() {
            let reconnectDelay = 1000;  // Start with 1 second
            const maxDelay = 5000;      // Max 5 seconds
            let reconnectAttempts = 0;

            function setupWebSocket() {
                const wsUrl = (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
                    + window.location.host + '/ws';

                const ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    console.log('WebSocket connected');
                    reconnectDelay = 1000;  // Reset delay on successful connection
                    reconnectAttempts = 0;
                };

                ws.onmessage = function(evt) {
                    try {
                        const data = JSON.parse(evt.data);
                        if (data.event === 'rtm-update') {
                            // Trigger HTMX refresh on elements listening for rtm-update
                            htmx.trigger(document.body, 'rtm-update');
                        }
                    } catch (e) {
                        // Ignore non-JSON messages (like pong)
                    }
                };

                ws.onclose = function(evt) {
                    console.log('WebSocket closed, reconnecting in ' + reconnectDelay + 'ms');
                    setTimeout(function() {
                        reconnectAttempts++;
                        // Exponential backoff: 1s, 2s, 4s, 5s (capped)
                        reconnectDelay = Math.min(reconnectDelay * 2, maxDelay);
                        setupWebSocket();
                    }, reconnectDelay);
                };

                ws.onerror = function(err) {
                    console.error('WebSocket error:', err);
                    ws.close();
                };

                // Store reference for ping
                window._rtmxWebSocket = ws;
            }

            // Initialize WebSocket
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupWebSocket);
            } else {
                setupWebSocket();
            }

            // Ping to keep WebSocket alive
            setInterval(function() {
                if (window._rtmxWebSocket && window._rtmxWebSocket.readyState === WebSocket.OPEN) {
                    window._rtmxWebSocket.send('ping');
                }
            }, 30000);
        })();
    </script>
</body>
</html>
